<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="DexcomWindows.Views.TrayPopupView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:DexcomWindows.Views"
    mc:Ignorable="d">

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <!-- Login View (shown when not authenticated) -->
        <ScrollViewer x:Name="LoginPanel" Visibility="Visible" 
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <StackPanel Padding="32" Spacing="16" 
                        MaxWidth="450" 
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                
                <TextBlock Text="Dexcom" 
                           FontSize="36" 
                           FontWeight="SemiBold" 
                           HorizontalAlignment="Center"
                           Margin="0,20,0,0"/>
                <TextBlock Text="Sign in to view your glucose data" 
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           HorizontalAlignment="Center"
                           FontSize="14"
                           Margin="0,0,0,20"/>
                
                <ComboBox x:Name="ServerComboBox" 
                          Header="Region" 
                          HorizontalAlignment="Stretch" 
                          SelectedIndex="0"
                          Margin="0,0,0,8">
                    <ComboBoxItem Content="United States" Tag="US"/>
                    <ComboBoxItem Content="Outside US (International)" Tag="International"/>
                </ComboBox>
                
                <TextBox x:Name="UsernameTextBox" 
                         Header="Username or Email" 
                         PlaceholderText="Enter your Dexcom username or email"
                         Margin="0,0,0,8"/>
                
                <PasswordBox x:Name="PasswordBox" 
                             Header="Password" 
                             PlaceholderText="Enter your password"
                             Margin="0,0,0,8"/>
                
                <InfoBar x:Name="LoginErrorBar" 
                         IsOpen="False" 
                         Severity="Error" 
                         Title="Error"
                         Margin="0,0,0,8"/>
                
                <Button x:Name="LoginButton" 
                        Content="Sign In" 
                        Style="{StaticResource AccentButtonStyle}"
                        HorizontalAlignment="Stretch"
                        Click="LoginButton_Click"
                        Padding="0,12"
                        FontSize="16"
                        Margin="0,8,0,0"/>
                
                <ProgressRing x:Name="LoginProgress" 
                              IsActive="False" 
                              Visibility="Collapsed" 
                              HorizontalAlignment="Center"
                              Width="40"
                              Height="40"/>
                
                <!-- Help text -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                        CornerRadius="8" 
                        Padding="16"
                        Margin="0,16,0,0">
                    <StackPanel Spacing="8">
                        <TextBlock Text="Need help?" FontWeight="SemiBold"/>
                        <TextBlock Text="• Make sure Dexcom Share is enabled in your G7 app" 
                                   TextWrapping="Wrap"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   FontSize="13"/>
                        <TextBlock Text="• You need at least one follower who has ACCEPTED the invitation" 
                                   TextWrapping="Wrap"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   FontSize="13"/>
                        <TextBlock Text="• Use the same login as your Dexcom app" 
                                   TextWrapping="Wrap"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   FontSize="13"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Main Content (shown when authenticated) -->
        <Grid x:Name="MainContent" Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header with Glucose Value -->
            <Grid x:Name="HeaderGrid" Grid.Row="0" Padding="24,20">
                <Grid.Background>
                    <SolidColorBrush x:Name="HeaderBackground" Color="#34C759"/>
                </Grid.Background>

                <StackPanel HorizontalAlignment="Center">
                    <!-- Main Value Row -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="12">
                        <TextBlock x:Name="GlucoseValueText"
                                   Text="--"
                                   FontSize="72"
                                   FontWeight="Bold"
                                   Foreground="White"/>
                        <TextBlock x:Name="TrendArrowText"
                                   Text=""
                                   FontSize="48"
                                   VerticalAlignment="Center"
                                   Foreground="White"/>
                    </StackPanel>

                    <!-- Time Ago -->
                    <TextBlock x:Name="TimeAgoText"
                               Text=""
                               FontSize="16"
                               HorizontalAlignment="Center"
                               Foreground="White"
                               Opacity="0.9"
                               Margin="0,8,0,0"/>

                    <!-- Trend Description -->
                    <TextBlock x:Name="TrendDescriptionText"
                               Text=""
                               FontSize="14"
                               HorizontalAlignment="Center"
                               Foreground="White"
                               Opacity="0.8"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Grid>

            <!-- Update Progress Bar -->
            <ProgressBar x:Name="UpdateProgressBar"
                         Grid.Row="1"
                         Minimum="0" Maximum="100" Value="0"
                         Height="4"/>

            <!-- Middle content area (statistics) -->
            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                <StackPanel Padding="24,16">
                    <!-- Statistics Row -->
                    <Grid x:Name="StatsGrid">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" HorizontalAlignment="Center" Spacing="4">
                            <TextBlock Text="Average" FontSize="13"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                            <TextBlock x:Name="AverageText" Text="--" FontSize="28" FontWeight="SemiBold"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" HorizontalAlignment="Center" Spacing="4">
                            <TextBlock Text="Std Dev" FontSize="13"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                            <TextBlock x:Name="StdDevText" Text="--" FontSize="28" FontWeight="SemiBold"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2" HorizontalAlignment="Center" Spacing="4">
                            <TextBlock Text="In Range" FontSize="13"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                            <TextBlock x:Name="TimeInRangeText" Text="--" FontSize="28" FontWeight="SemiBold"
                                       HorizontalAlignment="Center" Foreground="#34C759"/>
                        </StackPanel>
                    </Grid>

                    <!-- Error Banner -->
                    <InfoBar x:Name="ErrorBar"
                             IsOpen="False"
                             Severity="Error"
                             IsClosable="True"
                             Margin="0,16,0,0"/>
                </StackPanel>
            </ScrollViewer>

            <!-- Footer Buttons -->
            <Border Grid.Row="3" 
                    BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}" 
                    BorderThickness="0,1,0,0"
                    Padding="16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button Grid.Column="0"
                            Style="{StaticResource SubtleButtonStyle}"
                            HorizontalAlignment="Center"
                            Click="RefreshButton_Click"
                            ToolTipService.ToolTip="Refresh data"
                            Padding="16,10">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE72C;" FontSize="16"/>
                            <TextBlock Text="Refresh" FontSize="14"/>
                        </StackPanel>
                    </Button>

                    <Button Grid.Column="1"
                            Style="{StaticResource SubtleButtonStyle}"
                            HorizontalAlignment="Center"
                            Click="SettingsButton_Click"
                            ToolTipService.ToolTip="Settings"
                            Padding="16,10">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE713;" FontSize="16"/>
                            <TextBlock Text="Settings" FontSize="14"/>
                        </StackPanel>
                    </Button>

                    <Button Grid.Column="2"
                            Style="{StaticResource SubtleButtonStyle}"
                            HorizontalAlignment="Center"
                            Click="QuitButton_Click"
                            ToolTipService.ToolTip="Quit application"
                            Padding="16,10">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7E8;" FontSize="16"/>
                            <TextBlock Text="Quit" FontSize="14"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
